@startuml Risk_Assessment_Flow
!theme vibrant
skinparam backgroundColor White
skinparam shadowing false
title RiskControl SDK - 风险评估流程

start

:应用调用 assessRisk();

partition "数据收集" {
    fork
        :获取设备指纹数据;
        note left
          设备指纹权重分配:
          • 硬件指纹: 35%
          • 软件指纹: 25%
          • 网络指纹: 20%
          • 系统指纹: 20%
        end note
        
    fork again
        :获取安全检测结果;
        note right
          安全检测权重:
          • 调试检测: 25%
          • Hook检测: 30%
          • Root检测: 20%
          • 模拟器检测: 15%
          • 网络安全: 10%
        end note
        
    fork again
        :获取历史行为数据;
        note left
          行为分析因子:
          • 调用频率模式
          • 异常操作记录
          • 时间分布特征
          • 地理位置变化
        end note
        
    end fork
}

partition "设备唯一性评估" {
    :计算设备指纹熵值;
    
    fork
        :硬件指纹分析;
        :计算硬件组合唯一性;
        
        if (硬件指纹重复率 > 5%?) then (是)
            :硬件唯一性: 低;
            :风险分数 +15;
        elseif (硬件指纹重复率 > 1%?) then (是)
            :硬件唯一性: 中;
            :风险分数 +8;
        else (否)
            :硬件唯一性: 高;
            :风险分数 +2;
        endif
        
    fork again
        :软件指纹分析;
        :分析软件配置组合;
        
        if (软件配置常见?) then (是)
            :软件唯一性: 低;
            :风险分数 +10;
        else (否)
            :软件唯一性: 高;
            :风险分数 +3;
        endif
        
    fork again
        :网络指纹分析;
        :检查网络环境变化;
        
        if (网络环境频繁变化?) then (是)
            :网络稳定性: 低;
            :风险分数 +12;
        else (否)
            :网络稳定性: 高;
            :风险分数 +1;
        endif
        
    end fork
    
    :综合设备唯一性评分;
}

partition "安全威胁评估" {
    :分析安全检测结果;
    
    fork
        :调试威胁评估;
        if (检测到调试器?) then (是)
            :调试威胁: 高;
            :风险分数 +25;
            note right: 调试环境表示可能的逆向分析
        else (否)
            :调试威胁: 无;
        endif
        
    fork again
        :Hook威胁评估;
        if (检测到Hook框架?) then (是)
            switch (Hook类型)
                case (Frida)
                    :Hook威胁: 极高;
                    :风险分数 +35;
                case (Xposed)
                    :Hook威胁: 高;
                    :风险分数 +30;
                case (Substrate)
                    :Hook威胁: 中;
                    :风险分数 +20;
            endswitch
        else (否)
            :Hook威胁: 无;
        endif
        
    fork again
        :Root威胁评估;
        if (检测到Root?) then (是)
            :Root威胁: 中高;
            :风险分数 +22;
            note left: Root权限可能被恶意利用
        else (否)
            :Root威胁: 无;
        endif
        
    fork again
        :模拟器威胁评估;
        if (检测到模拟器?) then (是)
            :模拟器威胁: 中;
            :风险分数 +18;
            note right: 模拟器环境便于自动化攻击
        else (否)
            :模拟器威胁: 无;
        endif
        
    fork again
        :网络威胁评估;
        if (检测到网络威胁?) then (是)
            switch (网络威胁类型)
                case (代理/VPN)
                    :网络威胁: 中;
                    :风险分数 +15;
                case (中间人攻击)
                    :网络威胁: 高;
                    :风险分数 +25;
                case (异常流量)
                    :网络威胁: 中低;
                    :风险分数 +10;
            endswitch
        else (否)
            :网络威胁: 无;
        endif
        
    end fork
    
    :综合安全威胁评分;
}

partition "行为模式分析" {
    :分析调用行为模式;
    
    fork
        :频率分析;
        :计算调用频率分布;
        
        if (调用频率异常?) then (是)
            switch (异常类型)
                case (频率过高)
                    :可能为自动化攻击;
                    :风险分数 +20;
                case (频率规律性异常)
                    :可能为脚本调用;
                    :风险分数 +15;
                case (突发性调用)
                    :可能为测试行为;
                    :风险分数 +10;
            endswitch
        else (否)
            :调用频率正常;
            :风险分数 -2;
        endif
        
    fork again
        :时序分析;
        :分析调用时间分布;
        
        if (时间分布异常?) then (是)
            :可能为非人工操作;
            :风险分数 +12;
        else (否)
            :时间分布正常;
            :风险分数 -1;
        endif
        
    fork again
        :地理位置分析;
        :分析位置变化模式;
        
        if (位置变化异常?) then (是)
            switch (变化模式)
                case (瞬间跨地区)
                    :可能为代理/VPN;
                    :风险分数 +18;
                case (频繁位置切换)
                    :可能为模拟器;
                    :风险分数 +15;
            endswitch
        else (否)
            :位置模式正常;
        endif
        
    end fork
    
    :综合行为模式评分;
}

partition "机器学习辅助评估" {
    :输入特征向量;
    
    note right
      特征向量包括:
      • 设备硬件特征 (20维)
      • 安全检测结果 (15维)
      • 行为模式特征 (25维)
      • 网络环境特征 (10维)
    end note
    
    :应用训练好的风险评估模型;
    
    fork
        :异常检测模型;
        :检测设备指纹异常模式;
        :输出异常概率;
        
    fork again
        :分类模型;
        :分类设备风险等级;
        :输出风险类别概率;
        
    fork again
        :回归模型;
        :预测具体风险分数;
        :输出数值风险评估;
        
    end fork
    
    :融合多模型结果;
    :计算置信度;
}

partition "风险等级计算" {
    :汇总所有风险分数;
    
    note left
      风险分数组成:
      • 基础分数: 0分
      • 设备唯一性: ±20分
      • 安全威胁: +0~150分
      • 行为异常: +0~50分
      • ML模型调整: ±30分
    end note
    
    :计算最终风险分数;
    :应用风险阈值;
    
    if (风险分数 >= 80?) then (是)
        :风险等级: 5 (极高);
        :风险描述: "检测到严重安全威胁";
        
    elseif (风险分数 >= 60?) then (是)
        :风险等级: 4 (高);
        :风险描述: "检测到明显安全风险";
        
    elseif (风险分数 >= 40?) then (是)
        :风险等级: 3 (中);
        :风险描述: "检测到潜在安全风险";
        
    elseif (风险分数 >= 20?) then (是)
        :风险等级: 2 (低);
        :风险描述: "轻微安全风险";
        
    else (否)
        :风险等级: 1 (极低);
        :风险描述: "未发现明显风险";
        
    endif
}

partition "风险因子详细分析" {
    :生成风险因子报告;
    
    fork
        :设备相关风险;
        :列出设备指纹异常项;
        :分析硬件/软件风险点;
        
    fork again
        :安全相关风险;
        :列出检测到的威胁;
        :分析威胁影响程度;
        
    fork again
        :行为相关风险;
        :列出异常行为模式;
        :分析行为风险等级;
        
    fork again
        :环境相关风险;
        :列出环境异常因素;
        :分析环境风险影响;
        
    end fork
    
    :按风险等级排序因子;
    :生成风险缓解建议;
}

partition "动态风险调整" {
    :考虑时间衰减因子;
    
    note right
      时间衰减规则:
      • 威胁检测时间越久，风险权重越小
      • 最近24小时内检测：权重100%
      • 24-72小时：权重70%
      • 72小时以上：权重40%
    end note
    
    :考虑环境变化因子;
    :考虑历史信誉积分;
    
    if (设备有良好历史记录?) then (是)
        :风险分数 -10;
        :信誉加成;
    else (否)
        :无信誉调整;
    endif
    
    :应用动态调整后的最终分数;
}

partition "结果封装和缓存" {
    :创建RiskScore对象;
    
    fork
        :设置风险等级;
    fork again
        :设置风险分数;
    fork again
        :设置风险描述;
    fork again
        :设置风险因子列表;
    fork again
        :设置置信度;
    fork again
        :设置评估时间戳;
    fork again
        :设置有效期;
    end fork
    
    :更新本地风险缓存;
    note left
      缓存策略:
      • 缓存有效期: 30分钟
      • 风险等级变化时立即失效
      • 最多保留最近10次评估结果
    end note
}

:返回风险评估结果;

stop

note right
  <b>评估维度</b>
  • 设备指纹唯一性
  • 安全威胁程度
  • 行为模式异常
  • 机器学习辅助
end note

note left
  <b>评估特点</b>
  • 多维度综合评估
  • 动态权重调整
  • 时间衰减机制
  • 历史信誉考量
end note

@enduml