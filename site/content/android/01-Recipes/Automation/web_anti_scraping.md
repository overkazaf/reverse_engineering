---
title: "Web 反爬虫技术"
weight: 10
---

# Web 反爬虫技术

> **📚 前置知识**
>
> 本配方涉及以下核心技术，建议先阅读相关章节：
>
> - **[TLS 指纹技术](../Network/tls_fingerprinting_guide.md)** - 理解 JA3/JA4 指纹检测
> - **[验证码绕过技术](../Anti-Detection/captcha_bypassing_techniques.md)** - 滑块与点选验证码

网络爬虫是自动从网站提取数据的过程。由于这可能被滥用，许多现代网站和服务实施了复杂的反爬虫（或"反机器人"）技术来保护其数据。这些技术可大致分为客户端（浏览器）和服务器端防御。

---

## 1. 客户端（浏览器）挑战

这些防御措施的重点是确保客户端是由人类操作的真实、标准的网络浏览器。

- **JavaScript (JS) 挑战**: 服务器发送一段复杂的 JavaScript，客户端必须正确执行。该脚本可能执行计算、与浏览器 API 交互，并生成一个必须在后续请求中发回的令牌。需要使用像 Puppeteer 或 Selenium 这样的无头浏览器来通过这些挑战。

  - **例子**: Akamai Bot Manager, Cloudflare Bot Management。

- **浏览器指纹**: 服务器收集客户端浏览器环境的详细画像。这包括：

  - `User-Agent`、屏幕分辨率、颜色深度、时区。
  - 安装的字体、浏览器插件。
  - 浏览器 JS 引擎或渲染引擎（Canvas）行为的细微差异。

- **TLS 指纹**: 分析客户端 TLS 握手的参数（密码套件、扩展等）。

  - 与标准浏览器画像（例如，Windows 上的 Chrome）的偏差可用于将客户端标记为机器人。

- **CAPTCHA**: "全自动区分计算机和人类的公开图灵测试"。这需要用户解决一个对机器人来说很困难的挑战（例如，在图像中识别物体）。
  - **例子**: 谷歌的 reCAPTCHA (v2/v3), hCaptcha。绕过这些通常需要使用第三方破解服务。

## 2. 服务器端检测

这些防御措施通过分析服务器上的请求模式来识别非人类行为。

- **IP 地址信誉**: 阻止或速率限制来自已知属于数据中心（如 AWS、谷歌云）或代理/VPN 服务的 IP 地址的请求。通常使用住宅代理来规避此问题。

- **速率限制**: 限制单个 IP 地址或用户帐户在给定时间段内可以发出的请求数量。爬虫必须遵守这些限制以避免被阻止。

- **行为分析**: 这是最先进的技术。服务器会长期跟踪用户行为，以建立"正常"人类交互的模型。
  - **鼠标移动和按键**: 真实用户有混乱、非线性的鼠标移动和打字模式。机器人通常缺乏这一点。高级机器人必须模拟这种"人类"输入。
  - **导航模式**: 人类通过网站的路径是可预测但非完全线性的。机器人通常直接或以僵硬的顺序访问页面。
  - **请求时间**: 来自人类用户的请求之间的时间是可变的。机器人通常以固定的、最小的延迟运行。

---

## 规避策略

- **使用功能齐全的浏览器**: 使用 **Selenium**、**Puppeteer** 或 **Playwright** 等工具来自动化一个真实的浏览器。这有助于解决 JS 挑战并提供更具说服力的浏览器指纹。使用"stealth"插件进一步隐藏自动化。

- **轮换 IP**: 使用高质量的**住宅或移动代理**池来避免基于 IP 的封锁并模仿真实用户。

- **模仿人类行为**: 引入随机延迟，模拟逼真的鼠标移动，并以更像人类的方式在网站上导航。

- **逆向工程 JS**: 对于某些 JS 挑战，可以逆向工程混淆的 JavaScript 代码，以了解反机器人令牌是如何生成的。这使你可以在自己的脚本中复制逻辑，而无需完整的浏览器，这样会快得多。甚至可以使用 Frida 等工具来钩住浏览器进程以进行分析。

- **IP 质量检测**: 服务器端会检查请求 IP 的类型（数据中心、住宅、移动），并对来自数据中心的 IP 施加更严格的限制。

- **行为分析**: 服务器通过分析用户在一系列请求中的行为模式（如请求频率、访问路径、鼠标移动轨迹）来判断其是否为机器人。

---

## 专题：绕过 Cloudflare 五秒盾

Cloudflare 的"I'm Under Attack Mode"（我正遭受攻击模式）是一个非常常见的强力反机器人措施，用户会看到一个持续约五秒的"Checking your browser before accessing..."页面。这就是俗称的"五秒盾"。

### 1. 工作原理

五秒盾的核心是一个 **JavaScript 挑战 (JS Challenge)**。当用户首次访问受保护的页面时，服务器会返回一个包含复杂、高度混淆的 JavaScript 代码的 HTML 页面。这段 JS 的主要目的不是为了好看，而是为了：

1.  **环境检测**: 检查当前环境是否为一个真实的、标准的浏览器。它会检测 `window`, `document` 等对象，以及屏幕分辨率、时区、插件等浏览器指纹信息。
2.  **计算密集型任务**: 执行一系列复杂的数学运算。这些运算对于现代浏览器来说耗时很短（通常在 1-2 秒内），但对于不具备 JS 执行引擎的简单爬虫（如纯粹的 `requests` 库）来说是无法完成的。
3.  **生成验证 Token**: JS 计算的最终结果会作为一个 Token，通过表单提交或 Ajax 请求发送回 Cloudflare 的服务器进行验证。
4.  **设置身份 Cookie**: 验证通过后，Cloudflare 会在用户的浏览器中设置一个特殊的 Cookie（如 `__cf_bm` 或 `cf_clearance`），该 Cookie 在一定时间内有效。后续的请求只要携带这个有效的 Cookie，就可以直接访问网站，无需再次挑战。

### 2. 绕过方案

绕过五秒盾的核心思想是 **模拟一个能够成功执行其 JS 挑战的环境**。

#### a. 方案一：使用无头浏览器 (Headless Browser) - 推荐

这是最稳定、成功率最高的方案。使用 `Puppeteer` (Node.js), `Playwright` (Python/Node.js) 或 `Selenium` 等自动化浏览器框架。

- **工作方式**: 这些工具会启动一个真实的、完整的浏览器内核（如 Chrome），只是没有图形界面。当它们访问目标页面时，浏览器会像正常用户访问一样，自动执行所有的 JavaScript，完成挑战，获取 Cookie，然后继续访问目标页面。
- **优点**: 成功率极高，几乎能应对所有基于 JS 挑战的防护。
- **缺点**: 资源消耗大（需要启动整个浏览器），速度相对较慢。

**Playwright (Python) 示例：**
