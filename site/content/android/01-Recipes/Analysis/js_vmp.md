---
title: "JavaScript VMP 逆向工程"
weight: 10
---

# JavaScript VMP 逆向工程

> **📚 前置知识**
>
> 本配方涉及以下核心技术，建议先阅读相关章节：
>
> - **[JS OB 混淆分析](./js_obfuscator.md)** - 理解 JavaScript 混淆的基本原理
> - **AST 与编译原理** - 理解抽象语法树和字节码执行

JavaScript VMP（虚拟机保护）是一种高级的代码保护技术，它将原始的 JavaScript 代码转换成一种自定义的、基于虚拟机的字节码。然后，在运行时，一个内置的解释器（或虚拟机）会执行这些字节码。这种方式极大地增加了逆向工程的难度，因为它隐藏了原始的代码逻辑和结构。

## 核心原理

JSVMP 的核心思想是创建一个自定义的指令集和一个对应的虚拟机来执行它。

1. **代码转换（编译）**：

- **词法分析与解析**：将原始 JavaScript 代码解析成抽象语法树（AST）。

- **指令生成**：遍历 AST，将代码逻辑转换成自定义的字节码序列。例如，`a + b` 可能会被转换成 `PUSH a; PUSH b; ADD`。

- **虚拟机注入**：将实现了解释器、指令调度循环和操作函数的虚拟机（通常用 JavaScript 编写）与生成的字节码打包在一起。

2. **运行时执行**：

- **虚拟机初始化**：设置虚拟机的执行环境，如堆栈（Stack）、程序计数器（PC）和上下文。

- **指令循环（Fetch-Decode-Execute）**：
- **Fetch**：从字节码数组中获取当前 PC 指向的指令。

- **Decode**：解析指令的操作码和操作数。

- **Execute**：执行指令对应的操作，例如进行数学运算、操作堆栈、调用函数等。
- **程序结束**：当执行完所有字节码后，虚拟机将结果返回或完成操作。

## 常见特征

- **巨大的代码体积**：代码中通常包含一个非常大的数组（字节码）和一个庞大的 `switch` 或 `while` 循环（虚拟机解释器）。

- **控制流平坦化**：原始的 `if/else`, `for`, `while` 结构被转换成由程序计数器（PC）控制的跳转指令，使得代码逻辑难以跟踪。

- **不透明谓词**：引入一些恒为真或恒为假的复杂条件判断，增加静态分析的难度。

- **自定义数据结构**：使用自定义的堆栈来存储变量和中间结果，而不是直接使用 JavaScript 的变量。

## 分析与脱壳策略

逆向 JSVMP 是一个复杂的过程，通常需要结合静态和动态分析。

### 1. 静态分析：理解虚拟机

- **定位核心组件**：
- **字节码数组**：通常是一个巨大的、包含数字或短字符串的数组。

- **虚拟机入口**：启动整个解释器循环的函数。

- **分发器（Dispatcher）**：通常是一个大的 `switch` 语句或 `while(true)` 循环，根据指令码调用不同的处理函数。

- **指令处理器（Handlers）**：`switch` 中的每个 `case` 或被调用的函数，实现了具体指令的功能。
- **指令集重建**：
- 通过分析每个 Handler 的功能，逐步还原出每个字节码对应的具体操作（如 `ADD`, `SUB`, `JMP` 等）。

- 为每个操作码（Opcode）添加注释，记录其功能。这是一个非常耗时但至关重要的步骤。

### 2. 动态分析：跟踪与调试

- **Hook 关键函数**：使用 Frida 或浏览器开发者工具在关键位置（如指令处理器）下断点或插入日志。
- **跟踪 PC 和操作数**：记录每次循环的程序计数器（PC）和当前指令的操作数，可以得到完整的执行轨迹（Trace）。

- **监控堆栈变化**：观察虚拟机自定义堆栈的压入（push）和弹出（pop）操作，以理解数据流。
- **AST 辅助分析**：使用工具（如 Babel）将 Handler 的代码解析成 AST，可以更快地理解其功能，甚至自动化地识别指令模式。

### 3. 代码还原与重构

- **编写反编译器**：基于已经重建的指令集，编写一个脚本，将字节码序列翻译回更高级、更易读的 JavaScript 代码。这是一个高级步骤，需要对虚拟机有完整的理解。

- **手动逻辑重构**：对于不是特别复杂的 VMP，可以通过跟踪执行流程，手动将关键逻辑（如加密算法）用等效的 JavaScript 代码重写出来。

## 常用工具

- **浏览器开发者工具**：用于下断点、单步调试和观察变量。

- **Frida**：用于 Hook 关键函数，实现动态跟踪。

- **Babel**：用于将 JavaScript 代码解析成 AST，辅助静态分析。

- **AST Explorer**：一个在线工具，可以方便地查看代码对应的 AST 结构。

- **IDA Pro / Ghidra**：虽然主要用于原生代码，但它们强大的反汇编和反编译功能可以为理解复杂的 JavaScript 虚拟机逻辑提供借鉴。
